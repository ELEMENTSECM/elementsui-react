"use strict";
const UglifyJsPlugin = require("uglifyjs-webpack-plugin");
const paths = require("./paths");
const getClientEnvironment = require("./env");
const publicPath = paths.servedPath;
const publicUrl = publicPath.slice(0, -1);
const env = getClientEnvironment(publicUrl);
const merge = require("webpack-merge");
const BaseConfig = require("./webpack.config.umd.base");
if (env.stringified["process.env"].NODE_ENV !== '"production"') {
	throw new Error("Production builds must have NODE_ENV=production.");
}

module.exports = merge(BaseConfig, {
	output: {
		library: "elementsui-react",
		path: paths.lib,
		filename: "elementsui-react.umd.min.js",
		libraryTarget: "umd",
		umdNamedDefine: true
	},
	plugins: [
		new UglifyJsPlugin({
			uglifyOptions: {
				parse: {
					// we want uglify-js to parse ecma 8 code. However we want it to output
					// ecma 5 compliant code, to avoid issues with older browsers, this is
					// whey we put `ecma: 5` to the compress and output section
					// https://github.com/facebook/create-react-app/pull/4234
					ecma: 8
				},
				compress: {
					ecma: 5,
					warnings: false,
					// Disabled because of an issue with Uglify breaking seemingly valid code:
					// https://github.com/facebook/create-react-app/issues/2376
					// Pending further investigation:
					// https://github.com/mishoo/UglifyJS2/issues/2011
					comparisons: false
				},
				mangle: {
					safari10: true
				},
				output: {
					ecma: 5,
					comments: false,
					// Turned on because emoji and regex is not minified properly using default
					// https://github.com/facebook/create-react-app/issues/2488
					ascii_only: true
				}
			},
			// Use multi-process parallel running to improve the build speed
			// Default number of concurrent runs: os.cpus().length - 1
			parallel: true,
			// Enable file caching
			cache: true,
			sourceMap: true
		}) // Note: this won't work without ExtractTextPlugin.extract(..) in `loaders`.
	]
});
